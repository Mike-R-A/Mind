<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <canvas id="myCanvas" width="600" height="600"></canvas>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        const width = 600;
        const height = 600;
        $(document).ready(function () {
            var plants = [];

            for (var i = 0; i < 10; i++) {
                
                var x = Math.random() * width;
                var y = Math.random() * height;
                var senseOutputs = [
                    {id:"red", strength:3}
                ];

                var plant = new Plant(x, y, 5, senseOutputs);
                plants.push(plant)
            }

            var creature = new Creature(10, 10, 8, [], "creature1");
            creature.createSensorClump().done(function () {
                debugger;
                creature.detect(plants);
            }).fail(function () {
                console.log("FAIL")
            });

        });

        function drawCircle(x, y, radius) {
            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, 2 * Math.PI);
            ctx.stroke();
        }

        class Item {
            constructor(x, y, radius, senseOutputs) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.senseOutputs = senseOutputs;
                this.draw();
            }

            draw() {
                drawCircle(this.x, this.y, this.radius)
            }
        }

        class Creature extends Item {
            constructor(x, y, radius, senseOutputs, sensorClumpId, desiredSenseId = "health", xVelocity = 1, yVelocity = 0) {
                super(x, y, radius, senseOutputs);
                this.sensorClumpId = sensorClumpId;
                this.desiredSenseId = desiredSenseId;
                this.lastHealthAssociation = 0;
                this.xVelocity = xVelocity;
                this.yVelocity = yVelocity;
            }

            move(healthAssociation) {
                if (healthAssociation < this.lastHealthAssociation) {
                    this.changeDirection();
                }
                if (this.y + this.yVelocity < height) {
                    this.y += this.yVelocity;
                }
                if (this.x + this.xVelocity < width) {
                    this.x += this.xVelocity;
                }
            }

            changeDirection() {
                var angle = this.getRandomAngle();
                var xVelocity = getX(angle);
                var yVelocity = getY(angle);

                this.xVelocity(xVelocity);
                this.yVelocity(yVelocity);
            }

            getRandomAngle() {
                return Math.random() * 2 * Math.PI;
            }

            getX(angle, distance = 1) {
                return distance * Math.cos(angle);
            }

            getY(angle, distance = 1) {
                return distance * Math.sin(angle);
            }

            createSensorClump() {
                return $.ajax({
                    url: `https://localhost:44360/mind/SensorClump/${this.sensorClumpId}`,
                    type: "POST",
                    data: JSON.stringify(["red", "green", "blue", "health", "damage"]),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        console.log("SUCCESS");
                    }
                });
            }

            detect(items) {
                console.log("detect");
                setInterval(function () {
                    var senseInputs = [];
                    for (var item of items) {
                        for (var senseOutput of item.senseOutputs) {
                            var relevantSenseInput = senseInputs.filter(s => s.senseId = senseOutput.id)[0];
                            if (relevantSenseInput) {
                                relevantSenseInput.strength += senseOutput.strength;
                            } else {
                                senseInputs.push({senseId: senseOutput.id, strength: senseOutput.strength })
                            }
                        }
                    }
                    fireMultiple(this.sensorClumpId, senseInputs, this.desiredSenseId).done(result => {
                        this.move(result);
                        this.lastHealthAssociation = result;
                        this.draw();
                    });
                }.bind(this), 100);
            }
        }

        class Plant extends Item {

        }

        class Detectable {
            constructor(id, strength) {
                this.id = id;
                this.strength = strength;
            }
        }

        function fire(sensorClumpId, sensorId, strength) {
            var url = `https://localhost:44360/mind/fire/${sensorClumpId}/${sensorId}/${strength}`
            $.post(url);
        };

        function fireMultiple(sensorClumpId, senseInputs, desiredSenseId) {
            return $.ajax({
                url: `https://localhost:44360/mind/fireMultiple/${sensorClumpId}?desiredSenseId=${desiredSenseId}`,
                type: "POST",
                data: JSON.stringify(senseInputs),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    return data;
                }
            });
        };

    </script>
</body>
</html>